version: "3.9"

services:
  # ======================================================
  # 1. 数据库与基础组件
  # ======================================================
  mysql:
    image: mysql:8.0
    container_name: mysql8
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: workflow
    ports:
      - "23306:3306"
    volumes:
      - /data/docker-volumes/mysql_data:/var/lib/mysql
    networks:
      - project-net

  mongodb:
    image: mongo:6.0
    container_name: mongo6
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    ports:
      - "37018:27017"
    volumes:
      - /data/docker-volumes/mongo_data:/data/db
    networks:
      - project-net

  postgres:
    image: postgres:15-alpine
    container_name: dify-postgres
    restart: always
    environment:
      POSTGRES_USER: dify
      POSTGRES_PASSWORD: dify
      POSTGRES_DB: dify
    volumes:
      - /data/docker-volumes/dify_postgres:/var/lib/postgresql/data
    networks:
      - project-net

  redis:
    image: redis:7-alpine
    container_name: dify-redis
    restart: always
    networks:
      - project-net

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: dify-rabbitmq
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    networks:
      - project-net

  qdrant:
    image: qdrant/qdrant:v1.9.1
    container_name: qdrant
    restart: always
    volumes:
      - /data/docker-volumes/qdrant_data:/qdrant/storage
    networks:
      - project-net

  # ======================================================
  # 2. Keycloak 身份认证
  # ======================================================
  keycloak:
    image: xiz001/quant_keycloak:407568b
    container_name: quant_keycloak
    restart: always
    ports:
      - "18082:8080"
    environment:
      - KC_DB=mysql
      - KC_DB_URL=jdbc:mysql://mysql8:3306/keycloak?useSSL=false&allowPublicKeyRetrieval=true
      - KC_DB_USERNAME=root
      - KC_DB_PASSWORD=root
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=admin
    depends_on:
      - mysql
    networks:
      - project-net

  # ======================================================
  # 3. Quant 平台
  # ======================================================
  quant_api:
    image: xiz001/quant_api:fda9ded
    container_name: quant_api
    restart: always
    ports:
      - "18081:8081"
    depends_on:
      - mysql
      - mongodb
      - keycloak
    networks:
      - project-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  quant_ui:
    image: xiz001/quant_ui:ea196bb
    container_name: quant_ui
    restart: always
    ports:
      - "18080:80"
    depends_on:
      - quant_api
    networks:
      - project-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  quant_data:
    image: xiz001/quant_data:17781fe
    container_name: quant_data
    restart: always
    depends_on:
      - quant_api
    networks:
      - project-net
    volumes:
      - ./quant_data/scripts:/app/scripts
      - /data/docker-volumes/gdelt_cache:/app/cache_gdelt
    healthcheck:
      test: ["CMD", "python", "-c", "print('ok')"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ======================================================
  # 4. Dify 平台
  # ======================================================
  sandbox:
    image: langgenius/dify-sandbox:0.2.10
    container_name: dify-sandbox
    restart: always
    networks:
      - project-net

  dify-api:
    image: langgenius/dify-api:0.15.3
    container_name: dify-api
    restart: always
    ports:
      - "15001:5001"
    environment: &dify_env
      MODE: api
      VERSION: 0.15.3
      DEBUG: "true"
      SECRET_KEY: "dify-secret-change-me"
      DB_USERNAME: dify
      DB_PASSWORD: dify
      DB_HOST: postgres
      DB_PORT: 5432
      DB_DATABASE: dify
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_DB: 0
      VECTOR_STORE: qdrant
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333
      STORAGE_TYPE: local
      STORAGE_LOCAL_PATH: /app/storage
      CODE_EXECUTION_ENDPOINT: http://sandbox:8194
      CODE_EXECUTION_API_KEY: dify-sandbox
      CELERY_BROKER_URL: amqp://guest:guest@rabbitmq:5672//
      HTTP_ALLOW_CORS: "true"
      CORS_ALLOW_ORIGINS: "*"
      CONSOLE_CORS_ALLOW_ORIGINS: "*"
      WEB_API_CORS_ALLOW_ORIGINS: "*"
    volumes:
      - /data/docker-volumes/dify_storage:/app/storage
    depends_on:
      - postgres
      - redis
      - qdrant
      - sandbox
    networks:
      - project-net

  dify-worker:
    image: langgenius/dify-api:0.15.3
    container_name: dify-worker
    restart: always
    environment:
      <<: *dify_env
      MODE: worker
    volumes:
      - /data/docker-volumes/dify_storage:/app/storage
    depends_on:
      - dify-api
    networks:
      - project-net

  dify-web:
    image: langgenius/dify-web:0.15.3
    container_name: dify-web
    restart: always
    ports:
      - "18089:3000"
    environment:
      CONSOLE_API_URL: http://dify-api:5001
      APP_API_URL: http://dify-api:5001
    depends_on:
      - dify-api
    networks:
      - project-net

  # ======================================================
  # 5. LangChain Agent
  # ======================================================
  langchain-agent:
    image: xiz001/langchain_agent:c7c2aca
    container_name: langchain-agent
    restart: always
    ports:
      - "18000:8000"
    environment:
      - LOCAL_MODEL_NAME=qwen2:1.5b-instruct-q4
      - OPENAI_API_KEY=你的Key
      - QUANT_API=http://quant_api:8081
      - DIFY_API=http://dify-api:5001
    volumes:
      - /data/ollama/models:/models  
    depends_on:
      - dify-api
      - quant_api
    networks:
      - project-net

# ======================================================
# 网络
# ======================================================
networks:
  project-net:
    driver: bridge
